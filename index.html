<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 萬能工具箱 - 合併與分割</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PDF Library & ZIP Library -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        .drag-active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <i data-lucide="file-stack" class="text-blue-600 w-8 h-8"></i>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900">PDF 萬能工具箱</h1>
                </div>
                <div class="text-sm text-slate-500 hidden sm:block">
                    本機處理・無須上傳・支援大檔案
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- Tabs -->
        <div class="flex justify-center mb-8">
            <div class="bg-white p-1 rounded-xl shadow-sm border border-slate-200 inline-flex">
                <button onclick="switchTab('merge')" id="tab-merge" class="px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 bg-blue-600 text-white shadow-md flex items-center gap-2">
                    <i data-lucide="combine" class="w-4 h-4"></i> 合併 PDF
                </button>
                <button onclick="switchTab('split')" id="tab-split" class="px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 text-slate-600 hover:bg-slate-50 flex items-center gap-2">
                    <i data-lucide="scissors" class="w-4 h-4"></i> 分割/提取 PDF
                </button>
            </div>
        </div>

        <!-- Notification Area -->
        <div id="status-message" class="hidden mb-6 p-4 rounded-lg border"></div>

        <!-- MERGE SECTION -->
        <div id="section-merge" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 sm:p-8 animate-fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">合併多個 PDF 檔案</h2>
                <p class="text-slate-500 mt-1">將多個 PDF 文件按順序合併成一個檔案</p>
            </div>

            <!-- Upload Area -->
            <div id="drop-zone-merge" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-blue-400 hover:bg-slate-50">
                <input type="file" id="merge-input" class="hidden" multiple accept="application/pdf">
                <div class="flex flex-col items-center gap-3">
                    <div class="p-3 bg-blue-50 rounded-full text-blue-600">
                        <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <p class="font-medium text-lg">點擊選擇或拖放檔案至此</p>
                        <p class="text-sm text-slate-400 mt-1">支援同時選擇多個檔案</p>
                    </div>
                </div>
            </div>

            <!-- File List -->
            <div id="merge-file-list" class="mt-6 space-y-2 hidden">
                <h3 class="text-sm font-semibold text-slate-600 mb-2">待合併檔案列表 (將依此順序合併):</h3>
                <ul id="merge-list-items" class="space-y-2"></ul>
            </div>

            <!-- Action Button -->
            <div class="mt-8 flex justify-end">
                <button onclick="processMerge()" id="btn-merge" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium shadow-lg shadow-blue-600/20 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-all w-full sm:w-auto justify-center">
                    <span id="merge-btn-text">開始合併 PDF</span>
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- SPLIT SECTION -->
        <div id="section-split" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 p-6 sm:p-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">分割與提取 PDF 頁面</h2>
                <p class="text-slate-500 mt-1">從大檔案中提取特定頁面，或將每一頁拆分為獨立檔案</p>
            </div>

            <!-- Upload Area -->
            <div id="drop-zone-split" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-emerald-400 hover:bg-slate-50">
                <input type="file" id="split-input" class="hidden" accept="application/pdf">
                <div class="flex flex-col items-center gap-3">
                    <div class="p-3 bg-emerald-50 rounded-full text-emerald-600">
                        <i data-lucide="file-search" class="w-8 h-8"></i>
                    </div>
                    <div id="split-file-label">
                        <p class="font-medium text-lg">點擊選擇單一 PDF 檔案</p>
                        <p class="text-sm text-slate-400 mt-1">支援大型檔案</p>
                    </div>
                </div>
            </div>

            <!-- Options Area (Hidden until file selected) -->
            <div id="split-options" class="mt-8 p-6 bg-slate-50 rounded-xl border border-slate-200 hidden">
                <div class="flex flex-col sm:flex-row gap-6">
                    <!-- Option 1: Extract Range -->
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-3">
                            <input type="radio" name="split-mode" id="mode-extract" value="extract" checked class="w-4 h-4 text-blue-600">
                            <label for="mode-extract" class="font-bold text-slate-800 cursor-pointer">提取特定頁面 (合併為一個新檔案)</label>
                        </div>
                        <p class="text-xs text-slate-500 mb-3 ml-6">例如: 輸入 "1-3, 5, 8-10" 將會把這些頁面提取出來存成一份 PDF。</p>
                        <div class="ml-6">
                            <input type="text" id="page-range" placeholder="例如: 1-5, 8, 10-12" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                            <p id="page-count-display" class="text-xs text-slate-500 mt-2 text-right">尚未載入檔案</p>
                        </div>
                    </div>

                    <!-- Option 2: Explode to Zip -->
                    <div class="flex-1 border-t sm:border-t-0 sm:border-l border-slate-200 pt-4 sm:pt-0 sm:pl-6">
                        <div class="flex items-center gap-2 mb-3">
                            <input type="radio" name="split-mode" id="mode-explode" value="explode" class="w-4 h-4 text-blue-600">
                            <label for="mode-explode" class="font-bold text-slate-800 cursor-pointer">拆分所有頁面 (下載 ZIP)</label>
                        </div>
                        <p class="text-xs text-slate-500 ml-6">將 PDF 的每一頁拆分成獨立的 PDF 檔案，並打包成 ZIP 下載。</p>
                        <div class="ml-6 mt-4 p-3 bg-blue-50 text-blue-700 text-xs rounded border border-blue-100">
                            <i data-lucide="info" class="w-3 h-3 inline mr-1"></i> 適合批次處理合約或發票。
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <div class="mt-8 flex justify-end">
                <button onclick="processSplit()" id="btn-split" disabled class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-medium shadow-lg shadow-emerald-600/20 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-all w-full sm:w-auto justify-center">
                    <span id="split-btn-text">下載處理後的檔案</span>
                    <i data-lucide="download" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-slate-200 py-6 mt-8">
        <div class="container mx-auto px-4 text-center text-slate-500 text-sm">
            <p>100% 客戶端處理。您的檔案永遠不會離開這個瀏覽器。</p>
        </div>
    </footer>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // --- GLOBAL VARIABLES ---
        let mergeFiles = [];
        let splitFile = null;
        let splitFileDoc = null; // The loaded PDFDocument object

        // --- TAB SWITCHING ---
        function switchTab(tab) {
            const btnMerge = document.getElementById('tab-merge');
            const btnSplit = document.getElementById('tab-split');
            const secMerge = document.getElementById('section-merge');
            const secSplit = document.getElementById('section-split');

            if (tab === 'merge') {
                secMerge.classList.remove('hidden');
                secSplit.classList.add('hidden');
                btnMerge.className = "px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 bg-blue-600 text-white shadow-md flex items-center gap-2";
                btnSplit.className = "px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 text-slate-600 hover:bg-slate-50 flex items-center gap-2";
            } else {
                secMerge.classList.add('hidden');
                secSplit.classList.remove('hidden');
                btnSplit.className = "px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 bg-emerald-600 text-white shadow-md flex items-center gap-2";
                btnMerge.className = "px-6 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 text-slate-600 hover:bg-slate-50 flex items-center gap-2";
            }
            hideStatus();
        }

        // --- DRAG & DROP UTILS ---
        function setupDragDrop(zoneId, inputId, handleFilesCallback) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);

            zone.addEventListener('click', () => input.click());
            
            input.addEventListener('change', (e) => {
                if(e.target.files.length > 0) handleFilesCallback(e.target.files);
            });

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.add('drag-active'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.remove('drag-active'), false);
            });

            zone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFilesCallback(files);
            }, false);
        }

        // --- MERGE LOGIC ---
        setupDragDrop('drop-zone-merge', 'merge-input', (files) => {
            const list = document.getElementById('merge-list-items');
            const container = document.getElementById('merge-file-list');
            
            // Convert FileList to Array and add to global list
            Array.from(files).forEach(file => {
                if (file.type === "application/pdf") {
                    mergeFiles.push(file);
                }
            });

            if (mergeFiles.length > 0) {
                container.classList.remove('hidden');
                renderMergeList();
            }
        });

        function renderMergeList() {
            const list = document.getElementById('merge-list-items');
            list.innerHTML = '';
            mergeFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-slate-50 p-3 rounded border border-slate-200 text-sm";
                li.innerHTML = `
                    <span class="truncate max-w-[80%] flex items-center gap-2">
                        <i data-lucide="file" class="w-4 h-4 text-slate-400"></i> ${file.name} 
                        <span class="text-xs text-slate-400">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </span>
                    <button onclick="removeMergeFile(${index})" class="text-red-500 hover:text-red-700 p-1 hover:bg-red-50 rounded">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                list.appendChild(li);
            });
            lucide.createIcons();
        }

        function removeMergeFile(index) {
            mergeFiles.splice(index, 1);
            renderMergeList();
            if (mergeFiles.length === 0) {
                document.getElementById('merge-file-list').classList.add('hidden');
            }
        }

        async function processMerge() {
            if (mergeFiles.length < 2) {
                showStatus('請至少選擇兩個 PDF 檔案進行合併。', 'error');
                return;
            }

            setLoading('btn-merge', true, '正在合併中...');
            
            try {
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();

                for (const file of mergeFiles) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach((page) => mergedPdf.addPage(page));
                }

                const pdfBytes = await mergedPdf.save();
                downloadFile(pdfBytes, "merged-document.pdf", "application/pdf");
                showStatus('合併成功！檔案已開始下載。', 'success');
                
                // Clear list after success? Optional. Keeping them for now in case user wants to add more.
            } catch (err) {
                console.error(err);
                showStatus('合併失敗：' + err.message, 'error');
            } finally {
                setLoading('btn-merge', false, '開始合併 PDF');
            }
        }

        // --- SPLIT LOGIC ---
        setupDragDrop('drop-zone-split', 'split-input', async (files) => {
            if (files.length === 0) return;
            const file = files[0];
            
            if (file.type !== "application/pdf") {
                showStatus("請上傳 PDF 格式的檔案", "error");
                return;
            }

            splitFile = file;
            
            // Update UI
            document.getElementById('split-file-label').innerHTML = `
                <p class="font-bold text-lg text-emerald-700">${file.name}</p>
                <p class="text-sm text-slate-500 mt-1">讀取中...</p>
            `;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const { PDFDocument } = PDFLib;
                // Load only necessary parts initially for speed if possible, but load() usually reads all
                splitFileDoc = await PDFDocument.load(arrayBuffer);
                
                const pageCount = splitFileDoc.getPageCount();
                document.getElementById('split-file-label').innerHTML = `
                    <p class="font-bold text-lg text-emerald-700">${file.name}</p>
                    <p class="text-sm text-slate-500 mt-1">共 ${pageCount} 頁 • ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                `;
                
                document.getElementById('page-count-display').innerText = `文件共 ${pageCount} 頁 (可用範圍: 1-${pageCount})`;
                document.getElementById('split-options').classList.remove('hidden');
                document.getElementById('btn-split').disabled = false;
                
            } catch (err) {
                showStatus("無法讀取 PDF，檔案可能已加密或損壞。", "error");
                console.error(err);
            }
        });

        async function processSplit() {
            if (!splitFile || !splitFileDoc) return;

            const mode = document.querySelector('input[name="split-mode"]:checked').value;
            setLoading('btn-split', true, '處理中...');

            try {
                const { PDFDocument } = PDFLib;

                if (mode === 'extract') {
                    // Extract Mode
                    const rangeStr = document.getElementById('page-range').value.trim();
                    if (!rangeStr) throw new Error("請輸入頁碼範圍 (例如 1-3)");

                    const indices = parsePageRange(rangeStr, splitFileDoc.getPageCount());
                    if (indices.length === 0) throw new Error("無效的頁碼範圍");

                    const newPdf = await PDFDocument.create();
                    const copiedPages = await newPdf.copyPages(splitFileDoc, indices);
                    copiedPages.forEach(page => newPdf.addPage(page));

                    const pdfBytes = await newPdf.save();
                    downloadFile(pdfBytes, `extracted-${splitFile.name}`, "application/pdf");
                    showStatus(`成功提取 ${indices.length} 頁！`, 'success');

                } else {
                    // Explode Mode (Split All to ZIP)
                    const zip = new JSZip();
                    const pageCount = splitFileDoc.getPageCount();
                    
                    // Naming folder inside zip
                    const folder = zip.folder(splitFile.name.replace('.pdf', '') + "_split");

                    for (let i = 0; i < pageCount; i++) {
                        const newPdf = await PDFDocument.create();
                        const [copiedPage] = await newPdf.copyPages(splitFileDoc, [i]);
                        newPdf.addPage(copiedPage);
                        const pdfBytes = await newPdf.save();
                        
                        // Pad number with zeros (001, 002...)
                        const num = String(i + 1).padStart(3, '0');
                        folder.file(`page_${num}.pdf`, pdfBytes);
                    }

                    const zipContent = await zip.generateAsync({type: "blob"});
                    saveAs(zipContent, "split-pages.zip");
                    showStatus(`成功分割 ${pageCount} 頁並打包下載！`, 'success');
                }

            } catch (err) {
                console.error(err);
                showStatus(err.message, 'error');
            } finally {
                setLoading('btn-split', false, '下載處理後的檔案');
            }
        }

        // --- UTILITIES ---

        function parsePageRange(rangeStr, maxPages) {
            const pages = new Set();
            const parts = rangeStr.split(',');
            
            parts.forEach(part => {
                part = part.trim();
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(Number);
                    if (!isNaN(start) && !isNaN(end)) {
                        for (let i = start; i <= end; i++) {
                            if (i >= 1 && i <= maxPages) pages.add(i - 1); // 0-indexed
                        }
                    }
                } else {
                    const num = Number(part);
                    if (!isNaN(num) && num >= 1 && num <= maxPages) {
                        pages.add(num - 1);
                    }
                }
            });
            return Array.from(pages).sort((a, b) => a - b);
        }

        function downloadFile(data, filename, mimeType) {
            const blob = new Blob([data], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function setLoading(btnId, isLoading, text) {
            const btn = document.getElementById(btnId);
            const span = document.getElementById(btnId === 'btn-merge' ? 'merge-btn-text' : 'split-btn-text');
            const icon = btn.querySelector('svg');

            if (isLoading) {
                btn.disabled = true;
                span.innerText = text;
                // Replace icon with loader logic or just change text
                btn.classList.add('opacity-75', 'cursor-not-allowed');
                if(icon) icon.classList.add('hidden');
                
                // Add simple spinner
                const spinner = document.createElement('div');
                spinner.className = 'loader w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin ml-2';
                spinner.id = btnId + '-spinner';
                btn.appendChild(spinner);
            } else {
                btn.disabled = false;
                span.innerText = text;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                if(icon) icon.classList.remove('hidden');
                const spinner = document.getElementById(btnId + '-spinner');
                if(spinner) spinner.remove();
            }
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status-message');
            el.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'border-red-200', 'bg-green-50', 'text-green-700', 'border-green-200');
            
            if (type === 'error') {
                el.classList.add('bg-red-50', 'text-red-700', 'border-red-200');
            } else {
                el.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
            }
            el.innerText = msg;
            el.classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('status-message').classList.add('hidden');
        }
    </script>
</body>
</html>
